<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - FinalRoundApp</title>
  <link rel="stylesheet" href="/styles/dashboard/base.css" />
  <link rel="stylesheet" href="/styles/dashboard/components.css" />
  <script src="/js/dashboard/state.js"></script>
</head>
<body>
  <div class="app" id="appRoot">
    <aside class="sidebar" id="sidebar">
      <div class="sidebarBrand">
        <span class="logoDot"></span>
        <span>FinalRoundApp</span>
        <button class="btn btn-ghost btn-icon sidebarCloseBtn" id="sidebarCloseBtn" title="Close menu" aria-label="Close menu">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M18 6 6 18"></path>
            <path d="M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <nav class="nav" id="nav">
        <a href="#overview" data-route="overview" class="active">
          <span class="left">
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 10.5 12 3l9 7.5"></path>
                <path d="M5 10v10h14V10Z"></path>
              </svg>
            </span>
            <span class="label">Overview</span>
          </span>
          <span class="pill">Home</span>
        </a>
        <a href="#settings" data-route="settings">
          <span class="left">
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 21v-7"></path>
                <path d="M4 10V3"></path>
                <path d="M12 21v-9"></path>
                <path d="M12 8V3"></path>
                <path d="M20 21v-5"></path>
                <path d="M20 12V3"></path>
                <path d="M1 14h6"></path>
                <path d="M9 8h6"></path>
                <path d="M17 16h6"></path>
              </svg>
            </span>
            <span class="label">Settings</span>
          </span>
        </a>
        <a href="#profile" data-route="profile">
          <span class="left">
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21a8 8 0 0 0-16 0"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </span>
            <span class="label">Profile</span>
          </span>
        </a>
        <a href="#usage" data-route="usage">
          <span class="left">
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 19V5"></path><path d="M10 19V9"></path><path d="M16 19V12"></path><path d="M22 19V7"></path>
              </svg>
            </span>
            <span class="label">Usage</span>
          </span>
        </a>
        <a href="#billing" data-route="billing">
          <span class="left">
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="5" width="18" height="14" rx="2"></rect>
                <path d="M3 10h18"></path>
              </svg>
            </span>
            <span class="label">Billing &amp; invoices</span>
          </span>
        </a>
        <a href="#contact" data-route="contact">
          <span class="left">
            <span class="icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="6" width="18" height="14" rx="2"></rect>
                <path d="M3 8l9 6 9-6"></path>
              </svg>
            </span>
            <span class="label">Contact us</span>
          </span>
        </a>
      </nav>
    </aside>
    <div class="sidebarBackdrop" id="sidebarBackdrop" aria-hidden="true"></div>

    <main class="main">
      <div class="mainInner">
        <div class="topbar">
          <div class="topbarLeft">
            <button class="btn btn-ghost btn-icon sidebarToggleBtn" id="sidebarToggleBtn" title="Menu" aria-label="Open menu" aria-haspopup="true" aria-expanded="false">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M4 6h16"></path>
                <path d="M4 12h16"></path>
                <path d="M4 18h16"></path>
              </svg>
            </button>
            <div class="titleBlock">
              <div class="pageTitle" id="pageTitle">Overview</div>
              <div class="pageSub" id="pageSub">Plan snapshot and quick actions</div>
            </div>
          </div>
          <div class="actions">
            <button class="btn btn-secondary btn-icon" id="refreshBtn" title="Refresh" aria-label="Refresh">
              <svg class="refreshIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M21 12a9 9 0 1 1-3-6.7"></path>
                <path d="M21 3v7h-7"></path>
              </svg>
              <span class="srOnly">Refresh</span>
            </button>
            <div class="userMenu" id="userMenuWrap">
              <button class="btn btn-ghost btn-icon avatarBtn" id="userMenuBtn" title="Account" aria-label="Account menu" aria-haspopup="menu" aria-expanded="false">
                <span class="avatarCircle" id="userAvatarText" aria-hidden="true">U</span>
              </button>
              <div class="menu" id="userMenu" role="menu" aria-hidden="true">
                <div class="menuHeader">
                  <div class="menuTitle" id="userNameText">—</div>
                  <div class="menuSub" id="userEmailText">—</div>
                </div>
                <button class="menuItem" id="menuSignOut" role="menuitem">Sign out</button>
              </div>
            </div>
          </div>
        </div>

        <div class="view active" id="view-overview">
          <div class="card">
            <h1>Plan snapshot</h1>
            <div class="muted" id="periodText">Loading…</div>
            <div class="error" id="errorBox"></div>

            <div class="kpis">
              <div class="kpi">
                <div class="label">Current plan</div>
                <div class="value" id="planValue">—</div>
              </div>
              <div class="kpi">
                <div class="label">Transcription minutes remaining</div>
                <div class="value" id="minutesValue">—</div>
                <div class="bar"><div id="minutesBar"></div></div>
              </div>
              <div class="kpi">
                <div class="label">AI tokens remaining</div>
                <div class="value" id="tokensValue">—</div>
                <div class="bar"><div id="tokensBar"></div></div>
              </div>
            </div>
          </div>

          <div class="card">
            <h1>Current plan &amp; upgrades</h1>
            <div class="muted">Your current plan is highlighted. Higher tiers are available to upgrade.</div>
            <div class="plans" id="plansOverview"></div>
          </div>

          <div class="card">
            <h1>Daily AI token usage (this billing month)</h1>
            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:6px; flex-wrap:wrap;">
              <div class="muted">X = day, Y = tokens</div>
              <div style="display:flex; align-items:center; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
                <div class="seg" id="dailyRange">
                  <button type="button" data-days="1">1D</button>
                  <button type="button" data-days="7">7D</button>
                  <button type="button" data-days="30" class="active">30D</button>
                </div>
                <div class="dateRange" id="dailyDateRange">
                  <input type="date" id="dailyStart" />
                  <span class="arrow">→</span>
                  <input type="date" id="dailyEnd" />
                  <button type="button" class="btn btn-sm btn-apply" id="dailyApply">Apply</button>
                </div>
              </div>
            </div>
            <div class="error" id="dailyChartError" style="display:none;"></div>
            <div style="margin-top: 12px;">
              <canvas id="dailyTokensChart" style="width:100%; height:260px; display:block;"></canvas>
            </div>
          </div>
        </div>

        <div class="view" id="view-usage">
          <div class="card">
            <h1>Plan & Usage</h1>
            <div class="muted">Detailed usage and upgrade tiers.</div>
            <div class="error" id="errorBoxUsage" style="display:none;"></div>

            <div class="kpis" style="grid-template-columns: repeat(2, 1fr);">
              <div class="kpi">
                <div class="label">Minutes remaining</div>
                <div class="value" id="minutesValueUsage">—</div>
                <div class="bar"><div id="minutesBarUsage"></div></div>
              </div>
              <div class="kpi">
                <div class="label">Tokens remaining</div>
                <div class="value" id="tokensValueUsage">—</div>
                <div class="bar"><div id="tokensBarUsage"></div></div>
              </div>
            </div>
          </div>

          <div class="card">
            <h1>Daily AI token usage</h1>
            <div class="muted">Same range as the Overview chart.</div>
            <div class="error" id="dailyChartErrorUsage" style="display:none;"></div>
            <div style="margin-top: 12px;">
              <canvas id="dailyTokensChartUsage" style="width:100%; height:260px; display:block;"></canvas>
            </div>
          </div>

          <div class="card">
            <h1>Monthly usage (daily)</h1>
            <div class="muted">Daily AI token usage for the current billing month (up to today).</div>
            <div class="error" id="monthlyTableError" style="display:none;"></div>
            <div class="tableWrap" style="margin-top: 12px;">
              <table class="table" id="monthlyUsageTable"></table>
            </div>
          </div>
        </div>

        <div class="view" id="view-profile">
          <div class="card">
            <h1>Profile</h1>
            <div class="muted">Update your name, email, and password.</div>
            <div class="success" id="profileSuccess"></div>
            <div class="error" id="profileError" style="display:none;"></div>

            <div style="margin-top: 12px; font-weight: 900;">Name</div>
            <div class="formRow">
              <input class="input" type="text" id="profileName" placeholder="Full name" autocomplete="name" />
              <button class="btn btn-primary btn-sm" id="profileSaveNameBtn">Save</button>
            </div>

            <div style="margin-top: 16px; font-weight: 900;">Email</div>
            <div class="formRow">
              <input class="input" type="email" id="profileEmailCurrent" placeholder="Current email" autocomplete="email" disabled />
              <input class="input" type="email" id="profileEmailNew" placeholder="New email" autocomplete="email" />
              <button class="btn btn-primary btn-sm" id="profileStartEmailChangeBtn">Change</button>
            </div>

            <div id="emailChangeBox" style="display:none; margin-top: 10px;">
              <div class="muted" id="emailChangeHint">We sent a verification code to your current email.</div>
              <div class="formRow" id="emailChangeStep1" style="display:none;">
                <input class="input" type="text" id="profileCurrentEmailCode" placeholder="Code from current email" inputmode="numeric" />
                <button class="btn btn-light btn-sm" id="profileVerifyCurrentEmailBtn">Verify</button>
              </div>
              <div class="formRow" id="emailChangeStep2" style="display:none;">
                <input class="input" type="text" id="profileNewEmailCode" placeholder="Code from new email" inputmode="numeric" />
                <button class="btn btn-light btn-sm" id="profileVerifyNewEmailBtn">Verify</button>
              </div>
              <div class="formRow">
                <button class="btn btn-sm btn-revoke" id="profileCancelEmailChangeBtn">Cancel</button>
              </div>
            </div>

            <div style="margin-top: 16px; font-weight: 900;">Password</div>
            <div class="formRow">
              <input class="input" type="password" id="profileCurrentPassword" placeholder="Current password" autocomplete="current-password" />
              <input class="input" type="password" id="profileNewPassword" placeholder="New password (min 8 chars)" autocomplete="new-password" />
              <button class="btn btn-primary btn-sm" id="profileChangePasswordBtn">Change</button>
            </div>
          </div>
        </div>

        <div class="view" id="view-settings">
          <div class="card">
            <h1>Active sessions</h1>
            <div class="muted">Devices currently signed in to your account. You can sign out other sessions.</div>
            <div class="error" id="sessionsError" style="display:none;"></div>
            <div class="sessionsList" id="sessionsList"></div>
            <div style="margin-top: 10px; display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn btn-sm btn-light" id="sessionsShowMoreBtn" style="display:none;">Show more</button>
              <button class="btn btn-primary btn-sm" id="revokeOthersBtn">Sign out other sessions</button>
            </div>
          </div>
          <div class="card">
            <h1>Delete account</h1>
            <div class="muted">This permanently deletes your account and all related data. This can’t be undone.</div>
            <div class="dangerBox">
              This will delete: meeting sessions, modes, question templates, usage history, and sign-ins.
            </div>
            <div class="formRow">
              <input class="input" type="password" id="deletePassword" placeholder="Password" autocomplete="current-password" />
              <input class="input" type="text" id="deleteConfirm" placeholder="Type DELETE to confirm" />
              <button class="btn btn-danger" id="deleteAccountBtn" disabled>Delete account</button>
            </div>
            <div class="error" id="deleteError" style="display:none;"></div>
          </div>
        </div>

        <div class="view" id="view-spending">
          <div class="card">
            <h1>Spending</h1>
            <div class="muted">Plan and token usage snapshot.</div>
            <div class="error" id="errorBoxSpending" style="display:none;"></div>

            <div class="kpis" style="margin-top: 12px; grid-template-columns: repeat(2, 1fr);">
              <div class="kpi">
                <div class="label">AI tokens used</div>
                <div class="value" id="tokensUsedSpending">—</div>
                <div class="bar"><div id="tokensBarSpending"></div></div>
              </div>
              <div class="kpi">
                <div class="label">AI tokens remaining</div>
                <div class="value" id="tokensRemainingSpending">—</div>
              </div>
            </div>
          </div>
        </div>

        <div class="view" id="view-billing">
          <div class="card">
            <h1>Plans</h1>
            <div class="muted">Your current plan is highlighted. Click Upgrade or Downgrade to change your plan.</div>
            <div class="plans" id="plansBilling"></div>
          </div>
          <div class="card">
            <h1>Invoices</h1>
            <div class="muted">Date, description, status, and amount.</div>
            <div class="error" id="invoicesError" style="display:none;"></div>
            <div class="tableWrap" style="margin-top: 12px;">
              <table class="table" id="invoicesTable"></table>
            </div>
          </div>
        </div>

        <div class="view" id="view-payment">
          <div class="card">
            <p class="muted" style="margin-bottom:14px;"><a href="#billing" style="color:#4c1d95; text-decoration:underline;">← Back to Billing &amp; invoices</a></p>
            <h1>Subscribe with PayPal</h1>
            <div class="muted" id="payment-plan-label" style="margin-bottom:12px;">Subscribe with your PayPal account or card.</div>
            <div id="payment-message" style="display:none; margin-top:12px; margin-bottom:12px; padding:12px; border-radius:8px; font-weight:600;"></div>
            <div class="paypal-button-container" style="margin-top:12px;">
              <div id="payment-plan-pro" class="paypalWrap" style="display:none;"><span class="muted" style="display:block; margin-bottom:6px;">Pro</span><div id="paypalBtn_pro"></div><div class="muted" id="paypalNote_pro" style="margin-top:8px;"></div></div>
              <div id="payment-plan-pro_plus" class="paypalWrap" style="display:none;"><span class="muted" style="display:block; margin-bottom:6px;">Pro+</span><div id="paypalBtn_pro_plus"></div><div class="muted" id="paypalNote_pro_plus" style="margin-top:8px;"></div></div>
            </div>
          </div>
        </div>

        <div class="view" id="view-manage">
          <div class="card">
            <p class="muted" style="margin-bottom:14px;"><a href="#billing" style="color:#4c1d95; text-decoration:underline;">← Back to Billing &amp; invoices</a></p>
            <h1>Manage Subscription</h1>
            <div class="muted" id="subscription-info">Loading subscription details…</div>
            <div id="subscription-message" style="display:none; margin-top:12px; padding:12px; border-radius:8px; font-weight:600;"></div>
            <div style="margin-top:12px;">
              <button type="button" id="cancel-subscription-btn" class="btn btn-danger btn-sm" style="display:none;">Cancel Subscription</button>
            </div>
          </div>
        </div>

        <div class="view" id="view-docs">
          <div class="card">
            <h1>Docs</h1>
            <div class="placeholder">
              <div style="font-weight: 800; margin-bottom: 6px;">Helpful links</div>
              <div class="muted">Add your docs URLs here.</div>
              <ul style="margin-top: 10px; padding-left: 18px; line-height: 1.8;">
                <li><a href="/health" style="color:#4c1d95; text-decoration: underline;">API health check</a></li>
                <li><a href="/api/billing/me" style="color:#4c1d95; text-decoration: underline;">Billing API (requires auth)</a></li>
              </ul>
            </div>
          </div>
        </div>

        <div class="view" id="view-contact">
          <div class="card">
            <h1>Contact us</h1>
            <div class="placeholder">
              Email: <a href="mailto:hello@finalroundapp.com" style="color:#4c1d95; text-decoration: underline;">hello@finalroundapp.com</a>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Cancel Subscription Confirmation Modal -->
  <div id="cancel-subscription-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#1e1b4b; border-radius:16px; padding:24px; max-width:480px; width:90%; margin:20px; box-shadow:0 8px 32px rgba(0,0,0,0.4);">
      <h2 style="margin:0 0 16px 0; font-size:20px; font-weight:800; color:white;">Cancel Subscription</h2>
      <p style="margin:0 0 24px 0; color:rgba(255,255,255,0.8); line-height:1.6;">
        Your subscription will be cancelled at the end of your current billing period. You'll keep access to premium features until then, and no further charges will be made.
      </p>
      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button type="button" id="cancel-modal-cancel-btn" class="btn btn-ghost btn-sm" style="min-width:100px;">Cancel</button>
        <button type="button" id="cancel-modal-confirm-btn" class="btn btn-danger btn-sm" style="min-width:100px;">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Plan Change (Upgrade/Downgrade) Confirmation Modal -->
  <div id="downgrade-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#1e1b4b; border-radius:16px; padding:24px; max-width:480px; width:90%; margin:20px; box-shadow:0 8px 32px rgba(0,0,0,0.4);">
      <h2 style="margin:0 0 16px 0; font-size:20px; font-weight:800; color:white;">Change Subscription Plan</h2>
      <p style="margin:0 0 24px 0; color:rgba(255,255,255,0.8); line-height:1.6;">
        To change plans, we need to cancel your current subscription first. Your current subscription will be cancelled immediately, and then you can subscribe to the new plan.
      </p>
      <div id="downgrade-message" style="display:none; margin-bottom:20px; padding:12px; border-radius:8px; font-weight:600;"></div>
      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button type="button" id="downgrade-modal-cancel-btn" class="btn btn-ghost btn-sm" style="min-width:100px;">Cancel</button>
        <button type="button" id="downgrade-modal-confirm-btn" class="btn btn-primary btn-sm" style="min-width:100px;">Continue</button>
      </div>
    </div>
  </div>

  <script src="/js/dashboard/plans.js" defer></script>
  <script src="/js/dashboard/charts.js" defer></script>
  <script src="/js/dashboard/tables.js" defer></script>
  <script src="/js/dashboard/sessions.js" defer></script>
  <script src="/js/dashboard/profile.js" defer></script>
  <script src="/js/dashboard/paypal.js" defer></script>
  <script src="/js/dashboard/main.js" defer></script>
</body>
</html>